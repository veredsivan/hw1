#!/bin/bash

rules_file="$1"
packets=$(cat)
fixed_rules=$(sed -e 's/ //g' -e '/^$/d' -e 's/#.*//' -e 's/^,+//' -e 's/,+$//' -e 's/,+/,/g' "$rules_file" | grep -v '^$')

output=''

IFS=$'\n' packet_array=($packets) # Split packets into an array

for packet in "${packet_array[@]}"; do
  flag=0

  IFS=$'\n' read -rd '' -a rule_array <<< "$fixed_rules"

  for line in "${rule_array[@]}"; do
    all_valid="$packet"

    IFS=',' read -ra rule_parts <<< "$line"

    for rule in "${rule_parts[@]}"; do
      all_valid=$(echo "$all_valid" | ./firewall.exe "$rule")
    done

    if [[ "$packet" == "$all_valid" ]]; then
      output+="\n$packet" # Add the packet that matches the rule to the output
      flag=1
      break # Move to the next packet
    fi
  done

  if [[ $flag -eq 1 ]]; then
    break # Rule successful, move to the next packet
  fi
done

output=$(echo -e "$output" | grep -v '^$' | tr -d ' ' | sort -u)

echo -e "$output"
